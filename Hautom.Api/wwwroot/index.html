<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyEndesa Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #475569;
            --primary: #2563eb;
            --success: #059669;
            --radius: 8px;
            --font-sans: 'Inter', -apple-system, system-ui, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-page: #020617;
                --bg-card: #0f172a;
                --bg-hover: #1e293b;
                --border: #334155;
                --text-main: #f8fafc;
                --text-muted: #cbd5e1;
                --primary: #3b82f6;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-page);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        nav {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .logo { font-weight: 700; font-size: 1.1rem; color: var(--text-main); letter-spacing: -0.025em; }
        .nav-actions { display: flex; align-items: center; gap: 1.5rem; }
        .nav-link { color: var(--text-muted); text-decoration: none; font-size: 0.875rem; transition: color 0.2s; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .nav-link:hover { color: var(--text-main); }

        .container { max-width: 1280px; margin: 0 auto; padding: 2rem; }

        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem; gap: 1rem; }
        .page-title h2 { font-size: 1.5rem; font-weight: 700; }
        .page-title p { color: var(--text-muted); font-size: 0.875rem; }

        .controls { display: flex; gap: 0.75rem; align-items: center; }
        select, .btn {
            height: 40px;
            padding: 0 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn:hover { background: var(--bg-hover); }
        .btn-primary:hover { opacity: 0.9; background: var(--primary); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1.5rem; border-radius: var(--radius); transition: transform 0.2s; position: relative; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.875rem; font-weight: 700; color: var(--text-main); }
        .stat-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; font-weight: 500; }
        .stat-sim-badge {
            display: none; position: absolute; top: 8px; right: 8px;
            background: var(--primary); color: white; font-size: 0.6rem;
            padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase;
        }
        .stat-card.simulating .stat-sim-badge { display: inline; }
        .stat-card.simulating { border-color: var(--primary); }

        .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        @media (max-width: 1024px) { .grid-layout { grid-template-columns: 1fr; } }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-title { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .card-body { padding: 1.5rem; }
        .chart-container { height: 350px; position: relative; }

        .chart-controls { display: flex; align-items: center; gap: 1.5rem; }
        .chart-tabs { display: flex; background: var(--bg-hover); padding: 3px; border-radius: 8px; border: 1px solid var(--border); }
        .tab-btn {
            padding: 6px 14px; font-size: 0.75rem; font-weight: 600; border: none; background: transparent;
            color: var(--text-muted); cursor: pointer; border-radius: 6px; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .chart-toggles { display: flex; gap: 1rem; font-size: 0.8125rem; color: var(--text-main); font-weight: 500; }
        .chart-toggles label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .chart-toggles input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); }

        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th { text-align: left; padding: 1rem 1.5rem; background: var(--bg-hover); color: var(--text-main); font-weight: 700; border-bottom: 1px solid var(--border); position: relative; }
        th.sortable { cursor: pointer; transition: background 0.2s; }
        th.sortable:hover { background: var(--border); }
        th.sortable::after { content: '↕'; position: absolute; right: 10px; opacity: 0.3; }
        th.sort-asc::after { content: '↑'; opacity: 1; color: var(--primary); }
        th.sort-desc::after { content: '↓'; opacity: 1; color: var(--primary); }

        td { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); color: var(--text-main); }

        .price-new { font-weight: 700; color: var(--success); }
        .price-old { font-size: 0.75rem; color: var(--text-muted); text-decoration: line-through; display: block; }
        .price-sim { font-weight: 700; color: var(--primary); }
        tr.row-simulated { background: rgba(37, 99, 235, 0.05); }
        tr.row-simulated td:first-child { position: relative; }
        tr.row-simulated td:first-child::before {
            content: 'SIM'; position: absolute; left: 4px; top: 50%; transform: translateY(-50%);
            background: var(--primary); color: white; font-size: 0.5rem; padding: 1px 3px;
            border-radius: 2px; font-weight: 700;
        }
        tr.row-simulated td:first-child strong { margin-left: 28px; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        footer { margin-top: 4rem; padding: 2rem 0; border-top: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 0.875rem; }

        /* Simulation Panel */
        .simulation-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .simulation-panel.active { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
        .simulation-label { font-weight: 600; font-size: 0.875rem; color: var(--text-main); display: flex; align-items: center; gap: 0.5rem; }
        .simulation-badge { background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }

        /* Simulation Input */
        .sim-input-group { display: flex; align-items: center; gap: 0.5rem; }
        .sim-input-group label { font-size: 0.8125rem; color: var(--text-muted); font-weight: 500; }
        .sim-input {
            width: 100px; height: 36px; padding: 0 0.75rem;
            border: 1px solid var(--border); border-radius: var(--radius);
            background: var(--bg-page); color: var(--text-main);
            font-size: 0.875rem; font-weight: 600; text-align: center;
        }
        .sim-input:focus { outline: none; border-color: var(--primary); }
        .sim-input-decimal { width: 70px; border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: none; }
        .sim-prefix {
            background: var(--bg-hover); color: var(--text-main); font-size: 0.875rem; font-weight: 600;
            padding: 0 8px; height: 36px; display: flex; align-items: center;
            border: 1px solid var(--border); border-right: none;
            border-radius: var(--radius) 0 0 var(--radius);
        }
        .sim-unit { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }

        .sim-savings { margin-left: auto; font-size: 0.875rem; font-weight: 600; }
        .sim-savings.positive { color: var(--success); }
        .sim-savings.negative { color: #dc2626; }

        @media (max-width: 640px) {
            .simulation-panel { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .sim-savings { margin-left: 0; }
        }
    </style>
</head>
<body>

<nav>
    <div class="logo">MyEndesa Analytics</div>
    <div class="nav-actions">
        <span class="nav-link" onclick="openAbout()">Sobre</span>
        <a href="https://github.com/pwuexec/Hautom" target="_blank" class="nav-link">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
            GitHub
        </a>
    </div>
</nav>

<div class="container">
    <div class="page-header">
        <div class="page-title">
            <h2>Painel de Analítica</h2>
            <p>Monitorização de custos de energia</p>
        </div>
        <div class="controls">
            <select id="yearFilter">
                <option value="">Desde sempre</option>
            </select>
            <button class="btn btn-primary" onclick="processBills()">Processar Faturas</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-sim-badge">Simulação</span>
            <div class="stat-label">Total Gasto</div>
            <div class="stat-value" id="valTotalSpent">€0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Consumo Total</div>
            <div class="stat-value" id="valTotalKwh">0 kWh</div>
        </div>
        <div class="stat-card">
            <span class="stat-sim-badge">Simulação</span>
            <div class="stat-label" id="labelAvgPrice">Média Mensal</div>
            <div class="stat-value" id="valAvgPrice">€0.00</div>
        </div>
        <div class="stat-card">
            <span class="stat-sim-badge">Simulação</span>
            <div class="stat-label">Mês Mais Caro</div>
            <div class="stat-value" id="valMaxMonth">€0.00</div>
            <div class="stat-sub" id="subMaxMonth">-</div>
        </div>
    </div>

    <div class="simulation-panel" id="simPanel">
        <div class="simulation-label">
            Simulação
            <span class="simulation-badge" id="simBadge" style="display:none">Ativo</span>
        </div>
        <div class="sim-input-group">
            <label for="simKwhPrice">Preço kWh:</label>
            <span class="sim-prefix">0.</span>
            <input type="text" id="simKwhPrice" class="sim-input sim-input-decimal" inputmode="numeric" placeholder="1500" oninput="applySimulation()">
            <span class="sim-unit">€/kWh</span>
            <button class="btn" id="simClearBtn" onclick="clearSimulation()" style="display:none; padding: 0 12px;">Limpar</button>
        </div>
        <div class="sim-savings" id="simSavings"></div>
    </div>

    <div class="grid-layout">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Análise de Faturação</div>
                <div class="chart-controls">
                    <div class="chart-tabs">
                        <button class="tab-btn active" onclick="setChartType('line', this)">Linhas</button>
                        <button class="tab-btn" onclick="setChartType('bar', this)">Barras</button>
                    </div>
                    <div class="chart-toggles">
                        <label><input type="checkbox" id="toggleKwh" checked onchange="updateChartVisibility()"> kWh</label>
                        <label><input type="checkbox" id="toggleCost" checked onchange="updateChartVisibility()"> Custo</label>
                    </div>
                </div>
            </div>
            <div class="card-body"><div class="chart-container"><canvas id="mainChart"></canvas></div></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Divisão da Fatura</div></div>
            <div class="card-body"><div class="chart-container"><canvas id="breakdownChart"></canvas></div></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><div class="card-title">Registos Individuais</div><span id="billCount" style="color:var(--text-muted); font-weight: 500;"></span></div>
        <div style="overflow-x: auto;">
            <table id="billsTable">
                <thead>
                <tr>
                    <th class="sortable" onclick="sortTable('date', this)">Mês/Ano</th>
                    <th class="sortable" onclick="sortTable('totalKwh', this)">Consumo</th>
                    <th>Preço Unitário</th>
                    <th>Energia</th>
                    <th>Taxas</th>
                    <th class="sortable" onclick="sortTable('totalAmount', this)">Total</th>
                    <th style="text-align:right">Fatura</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <footer>
        <p><strong>MyEndesa Analytics</strong> — por pwuexec &bull; <span id="currentYear"></span></p>
    </footer>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target === this) closeModal()">
    <div class="modal">
        <div class="card-header"><div class="card-title" id="modalTitle"></div></div>
        <div class="card-body" id="modalBody"></div>
    </div>
</div>

<script>
    const date = new Date();
    document.getElementById('currentYear').textContent = date.getFullYear();

    let allBills = [];
    let originalBills = [];
    let mainChart, breakdownChart;
    let currentViewType = 'line';
    let sortConfig = { key: 'date', direction: 'desc' };
    let simulationEnabled = false;

    const monthsPT = {
        'January': 'Jan', 'February': 'Fev', 'March': 'Mar', 'April': 'Abr',
        'May': 'Mai', 'June': 'Jun', 'July': 'Jul', 'August': 'Ago',
        'September': 'Set', 'October': 'Out', 'November': 'Nov', 'December': 'Dez'
    };

    const monthToIndex = {
        'January': 0, 'February': 1, 'March': 2, 'April': 3, 'May': 4, 'June': 5,
        'July': 6, 'August': 7, 'September': 8, 'October': 9, 'November': 10, 'December': 11
    };

    const chartColors = {
        primary: '#2563eb',
        primaryMuted: 'rgba(37, 99, 235, 0.1)',
        secondary: '#64748b',
        secondaryMuted: 'rgba(100, 116, 139, 0.1)',
        text: getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim() || '#0f172a'
    };

    function openAbout() {
        document.getElementById('modalTitle').textContent = "Sobre o Projecto";
        document.getElementById('modalBody').innerHTML = `
                <div style="padding: 0.5rem;">
                    <p style="margin-bottom: 1rem; line-height: 1.5; font-size: 0.9rem; color: var(--text-main);">
                        Este projecto monitoriza custos reais de energia, focando no valor final pago após descontos e taxas.
                    </p>
                    <div style="background: var(--bg-hover); padding: 1rem; border-radius: 6px; border-left: 3px solid #f59e0b; margin-bottom: 1rem; font-size: 0.8rem;">
                        <strong>Nota:</strong> Os cálculos de média mensal consideram o valor total de cada fatura dividido pelo número de registos no período selecionado.
                    </div>
                    <button class="btn btn-primary" style="width: 100%" onclick="closeModal()">Fechar</button>
                </div>
            `;
        document.getElementById('modalOverlay').classList.add('active');
    }

    function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

    async function loadData(year = null) {
        let url = '/bills?pageSize=100';
        if (year && year !== "") {
            url += `&year=${year}`;
        }

        try {
            const res = await fetch(url);
            const data = await res.json();
            originalBills = data.items || [];
            allBills = JSON.parse(JSON.stringify(originalBills));

            // Definir preço médio como placeholder (apenas decimais)
            if (originalBills.length > 0) {
                const avgPrice = originalBills.reduce((s, b) => s + b.priceAfterDiscount, 0) / originalBills.length;
                const decimals = avgPrice.toFixed(4).split('.')[1] || '1500';
                document.getElementById('simKwhPrice').placeholder = decimals;
            }

            if (simulationEnabled) {
                applySimulation();
            } else {
                updateUI();
            }
        } catch (err) {
            console.error("Erro ao carregar dados:", err);
        }
    }

    function updateUI() {
        const filterEl = document.getElementById('yearFilter');
        const selectedLabel = filterEl.options[filterEl.selectedIndex].text;

        // Somatórios dos dados filtrados
        const totalSpent = allBills.reduce((s, b) => s + b.totalAmount, 0);
        const totalKwh = allBills.reduce((s, b) => s + b.totalKwh, 0);

        // Preço Médio Mensal: Total Gasto / Número de faturas (meses)
        const numMonths = allBills.length;
        const avgMonthlyPrice = numMonths > 0 ? (totalSpent / numMonths) : 0;

        // Mês com maior gasto (considerando o filtro)
        let maxMonthBill = null;
        if (allBills.length > 0) {
            maxMonthBill = allBills.reduce((prev, current) => (prev.totalAmount > current.totalAmount) ? prev : current);
        }

        document.getElementById('valTotalSpent').textContent = `€${totalSpent.toFixed(2)}`;
        document.getElementById('valTotalKwh').textContent = `${totalKwh.toLocaleString()} kWh`;
        document.getElementById('valAvgPrice').textContent = `€${avgMonthlyPrice.toFixed(2)}`;

        if (maxMonthBill) {
            document.getElementById('valMaxMonth').textContent = `€${maxMonthBill.totalAmount.toFixed(2)}`;
            document.getElementById('subMaxMonth').textContent = `${monthsPT[maxMonthBill.month]} ${maxMonthBill.year}`;
        } else {
            document.getElementById('valMaxMonth').textContent = `€0.00`;
            document.getElementById('subMaxMonth').textContent = `-`;
        }

        // Atualiza rótulo dinamicamente baseado no filtro
        document.getElementById('labelAvgPrice').textContent = `Média Mensal (${selectedLabel})`;

        renderCharts();
        renderTable();
    }

    function setChartType(type, btn) {
        currentViewType = type;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderCharts();
    }

    function updateChartVisibility() {
        if (!mainChart) return;
        mainChart.setDatasetVisibility(0, document.getElementById('toggleCost').checked);
        mainChart.setDatasetVisibility(1, document.getElementById('toggleKwh').checked);
        mainChart.update();
    }

    function renderCharts() {
        const ctxMain = document.getElementById('mainChart').getContext('2d');
        const sorted = [...allBills].sort((a,b) => a.year - b.year || monthToIndex[a.month] - monthToIndex[b.month]);
        const labels = sorted.map(b => `${monthsPT[b.month]} ${b.year}`);

        if (mainChart) mainChart.destroy();
        const isBar = currentViewType === 'bar';
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim() || '#0f172a';

        mainChart = new Chart(ctxMain, {
            data: {
                labels,
                datasets: [
                    {
                        type: isBar ? 'bar' : 'line',
                        label: 'Custo',
                        data: sorted.map(b => b.totalAmount),
                        borderColor: chartColors.primary,
                        backgroundColor: isBar ? chartColors.primary : chartColors.primaryMuted,
                        fill: !isBar,
                        tension: 0.3,
                        yAxisID: 'y'
                    },
                    {
                        type: isBar ? 'bar' : 'line',
                        label: 'Consumo',
                        data: sorted.map(b => b.totalKwh),
                        borderColor: chartColors.secondary,
                        backgroundColor: isBar ? chartColors.secondary : chartColors.secondaryMuted,
                        fill: !isBar,
                        tension: 0.3,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: textColor }, grid: { display: false } },
                    y: { position: 'left', ticks: { color: textColor }, title: { display: true, text: 'Euros (€)' } },
                    y1: { position: 'right', ticks: { color: textColor }, grid: { display: false }, title: { display: true, text: 'kWh' } }
                }
            }
        });

        const ctxPie = document.getElementById('breakdownChart').getContext('2d');
        if (breakdownChart) breakdownChart.destroy();
        breakdownChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['Energia', 'Taxas'],
                datasets: [{
                    data: [allBills.reduce((s,b)=>s+b.electricityValue,0), allBills.reduce((s,b)=>s+b.taxesAndFees,0)],
                    backgroundColor: [chartColors.primary, '#94a3b8']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
            }
        });
        updateChartVisibility();
    }

    function sortTable(key, thElement) {
        if (sortConfig.key === key) {
            sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortConfig.key = key;
            sortConfig.direction = 'desc';
        }
        document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
        thElement.classList.add(sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector('#billsTable tbody');
        const sorted = [...allBills].sort((a, b) => {
            let valA = (sortConfig.key === 'date') ? (a.year * 100 + monthToIndex[a.month]) : a[sortConfig.key];
            let valB = (sortConfig.key === 'date') ? (b.year * 100 + monthToIndex[b.month]) : b[sortConfig.key];
            return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
        });

        document.getElementById('billCount').textContent = `${sorted.length} registos encontrados`;
        tbody.innerHTML = sorted.map((b, idx) => {
            // Valores originais (para simulação)
            const orig = simulationEnabled ? originalBills.find(o => o.id === b.id) : null;
            const isSimulated = orig && (orig.priceAfterDiscount !== b.priceAfterDiscount);

            // Preço base (sem desconto) - mostrar apenas quando NÃO há simulação
            const hasDiscount = !isSimulated && b.basePrice && b.basePrice !== b.priceAfterDiscount;
            const totalWithoutDiscount = hasDiscount ? (b.totalKwh * b.basePrice + b.taxesAndFees) : null;

            // Construir célula de preço unitário
            let priceCell, totalCell;

            if (isSimulated) {
                // Simulação: valor simulado + valor real riscado (com badge)
                priceCell = `<span class="price-sim">€${b.priceAfterDiscount.toFixed(4)}</span><span class="price-old">€${orig.priceAfterDiscount.toFixed(4)}</span>`;
                totalCell = `<span class="price-sim">€${b.totalAmount.toFixed(2)}</span><span class="price-old">€${orig.totalAmount.toFixed(2)}</span>`;
            } else if (hasDiscount) {
                // Desconto: valor com desconto + valor base riscado
                priceCell = `<span class="price-new">€${b.priceAfterDiscount.toFixed(4)}</span><span class="price-old">€${b.basePrice.toFixed(4)}</span>`;
                totalCell = `<span class="price-new">€${b.totalAmount.toFixed(2)}</span><span class="price-old">€${totalWithoutDiscount.toFixed(2)}</span>`;
            } else {
                // Normal: apenas o valor
                priceCell = `<span class="price-new">€${b.priceAfterDiscount.toFixed(4)}</span>`;
                totalCell = `<span class="price-new">€${b.totalAmount.toFixed(2)}</span>`;
            }

            return `
            <tr class="${isSimulated ? 'row-simulated' : ''}">
                <td><strong>${monthsPT[b.month]} ${b.year}</strong></td>
                <td>${b.totalKwh.toLocaleString()} kWh</td>
                <td>${priceCell}</td>
                <td>€${b.electricityValue.toFixed(2)}</td>
                <td>€${b.taxesAndFees.toFixed(2)}</td>
                <td>${totalCell}</td>
                <td style="text-align:right"><a href="/bills/pdf/${b.id}" target="_blank" class="btn" style="padding:4px 12px; font-size:11px">PDF</a></td>
            </tr>`;
        }).join('');
    }

    function updateSimulationUI(active) {
        const panel = document.getElementById('simPanel');
        const badge = document.getElementById('simBadge');
        const clearBtn = document.getElementById('simClearBtn');
        const statCards = document.querySelectorAll('.stat-card');

        if (active) {
            panel.classList.add('active');
            badge.style.display = 'inline';
            clearBtn.style.display = 'inline';
            statCards.forEach(card => {
                if (card.querySelector('.stat-sim-badge')) {
                    card.classList.add('simulating');
                }
            });
        } else {
            panel.classList.remove('active');
            badge.style.display = 'none';
            clearBtn.style.display = 'none';
            statCards.forEach(card => card.classList.remove('simulating'));
        }
    }

    function clearSimulation() {
        document.getElementById('simKwhPrice').value = '';
        document.getElementById('simSavings').textContent = '';
        simulationEnabled = false;
        updateSimulationUI(false);
        allBills = JSON.parse(JSON.stringify(originalBills));
        updateUI();
    }

    function applySimulation() {
        const input = document.getElementById('simKwhPrice');
        const rawValue = input.value.replace(/[^0-9]/g, '');
        const newPrice = rawValue ? parseFloat('0.' + rawValue) : NaN;
        const savings = document.getElementById('simSavings');

        if (isNaN(newPrice) || newPrice <= 0 || rawValue === '') {
            simulationEnabled = false;
            updateSimulationUI(false);
            allBills = JSON.parse(JSON.stringify(originalBills));
            savings.textContent = '';
            updateUI();
            return;
        }

        simulationEnabled = true;
        updateSimulationUI(true);

        const originalTotal = originalBills.reduce((s, b) => s + b.totalAmount, 0);

        allBills = originalBills.map(bill => {
            const simulated = { ...bill };
            const originalKwhCost = bill.totalKwh * bill.priceAfterDiscount;
            const newKwhCost = bill.totalKwh * newPrice;
            const difference = newKwhCost - originalKwhCost;

            simulated.electricityValue = Math.max(0, bill.electricityValue + difference);
            simulated.totalAmount = simulated.electricityValue + bill.taxesAndFees;
            simulated.priceAfterDiscount = newPrice;

            return simulated;
        });

        const simulatedTotal = allBills.reduce((s, b) => s + b.totalAmount, 0);
        const diff = simulatedTotal - originalTotal;

        if (diff < 0) {
            savings.className = 'sim-savings positive';
            savings.textContent = `Poupança: €${Math.abs(diff).toFixed(2)}`;
        } else if (diff > 0) {
            savings.className = 'sim-savings negative';
            savings.textContent = `Custo adicional: +€${diff.toFixed(2)}`;
        } else {
            savings.className = 'sim-savings';
            savings.textContent = 'Sem diferença';
        }

        updateUI();
    }

    async function processBills() {
        const btn = document.querySelector('.btn-primary');
        btn.disabled = true;
        btn.textContent = "A processar...";
        try {
            await fetch('/bills/process', { method: 'POST' });
            await loadData();
        } finally {
            btn.disabled = false;
            btn.textContent = "Processar Faturas";
        }
    }

    document.getElementById('yearFilter').addEventListener('change', (e) => loadData(e.target.value));

    (async () => {
        await loadData();
        const years = [...new Set(allBills.map(b => b.year))].sort((a,b) => b-a);
        const select = document.getElementById('yearFilter');
        years.forEach(y => select.add(new Option(y, y)));
        document.querySelector('th.sortable').classList.add('sort-desc');
        updateUI();
    })();
</script>
</body>
</html>